<!-- Solo muestro aquí la parte del <script> final corregida -->
<script>
  // Verificar sesión
  const usuario = JSON.parse(localStorage.getItem("usuarioLogueado"));
  if (!usuario) {
    window.location.href = "index.html";
  }

  // Mostrar datos del usuario
  const datos = JSON.parse(localStorage.getItem("datosUsuario")) || {};
  const datosDiv = document.getElementById("datosUsuario");

  datosDiv.innerHTML = `
    <p><strong>Nombre:</strong> ${datos.nombres || "—"}</p>
    <p><strong>Apellido:</strong> ${datos.apellidos || "—"}</p>
    <p><strong>DNI:</strong> ${datos.dni || "—"}</p>
    <p><strong>Correo:</strong> ${usuario.email || "—"}</p>
  `;

  // Mostrar foto de perfil si existe
  if (datos.fotoBase64) {
    document.getElementById("fotoUsuario").src = datos.fotoBase64;
  }

  // Generar QR (enlace a página pública)
  const qrDiv = document.getElementById("qrPreview");
  QRCode.toDataURL("https://tusitio.com/qr-info.html", { width: 150 }, (err, url) => {
    if (!err) {
      const img = new Image();
      img.src = url;
      img.alt = "Código QR";
      qrDiv.appendChild(img);
      localStorage.setItem("qrGenerado", url);
    }
  });

  function descargarQR() {
    const qr = localStorage.getItem("qrGenerado");
    if (!qr) return alert("Aún no se ha generado el código QR");
    const link = document.createElement("a");
    link.href = qr;
    link.download = "mi_qr_vitaqr.png";
    link.click();
  }

  function cerrarSesion() {
    localStorage.removeItem("usuarioLogueado");
    location.href = "index.html";
  }

  // Modal login y menú responsivo
  const modal = document.getElementById("loginModal");
  const closeBtn = document.querySelector(".close");
  const loginForm = document.getElementById("loginForm");
  const abrirSesion = document.getElementById("abrirSesion");
  const toggle = document.getElementById("menu-toggle");
  const navbar = document.getElementById("navbar");

  abrirSesion.onclick = () => modal.style.display = "block";
  closeBtn.onclick = () => modal.style.display = "none";
  window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };

  loginForm.onsubmit = (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    if (email && password) {
      const userObj = {
        email: email,
        nombre: "Usuario" // reemplazar si se tiene nombre real
      };
      localStorage.setItem("usuarioLogueado", JSON.stringify(userObj));
      modal.style.display = "none";
      window.location.href = "perfil.html";
    }
  };

  toggle.onclick = () => {
    navbar.classList.toggle("active");
  };

  // Mostrar nombre del usuario en menú si está logueado
  const iconoUsuario = document.getElementById("abrirSesion");
  if (usuario && usuario.email) {
    iconoUsuario.innerHTML = `<i class="fas fa-user"></i> ${usuario.email.split("@")[0]}`;
    iconoUsuario.title = "Perfil";
    iconoUsuario.href = "perfil.html";
  }
</script>
